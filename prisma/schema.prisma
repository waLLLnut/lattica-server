// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. 암호문 저장소 (확정된 데이터)
model Ciphertext {
  handle      String   @id // 32 bytes Hex String (Primary Key)
  data        String   // Base64 encoded ciphertext
  owner       String   // Solana PublicKey (Base58)
  clientTag   String?  // Optional client tag (Hex)
  
  status      String   @default("pending") // pending | confirmed
  createdAt   DateTime @default(now())
  confirmedAt DateTime?

  // 빠른 조회를 위한 인덱스
  @@index([owner])
  @@index([status])
}

// 2. 연산 요청 로그 (블록체인 이벤트 기록용)
model OperationLog {
  signature     String   @id // Transaction Signature
  slot          BigInt   // Block Slot number
  blockTime     BigInt?  // Block Timestamp
  caller        String   // Caller PublicKey
  
  type          String   // Unary | Binary | Ternary
  operation     String   // AND, OR, ADD3 ... (Enum name)
  
  // 연산에 사용된 핸들들 (JSON 형태로 저장하거나, 별도 컬럼으로 분리 가능)
  // 여기서는 검색 편의를 위해 주요 핸들만 컬럼으로 뺍니다.
  inputHandles  String[] // [lhs, rhs] or [a, b, c]
  resultHandle  String?  // 결과 핸들

  createdAt     DateTime @default(now())

  @@index([caller])
  @@index([type])
  @@index([slot])
}

// 3. 인덱서 상태 관리 (서버 재시작 시 복구용)
model IndexerState {
  programId     String   @id // 모니터링 중인 프로그램 ID
  lastSlot      BigInt   @default(0)
  lastSignature String?
  updatedAt     DateTime @updatedAt
}

// 4. 이벤트 스트림 (Gap Filling용)
// SSE 연결 시 놓친 이벤트를 조회하기 위한 테이블
model EventStream {
  id          String   @id @default(uuid()) // Primary Key (UUID)
  eventId     String   @unique // Unique Event ID (for Last-Event-ID)
  eventType   String   // 이벤트 타입 (예: 'user.ciphertext.confirmed', 'user.operation.completed')
  targetOwner String?  // 대상 지갑 주소 (user 채널용)
  payload     Json     // 이벤트 페이로드 (JSON)
  signature   String?  // 트랜잭션 서명 (optional)
  slot        BigInt?  // 블록 슬롯 (optional)
  createdAt   DateTime @default(now())

  // 빠른 조회를 위한 인덱스
  @@index([targetOwner])
  @@index([eventType])
  @@index([slot])
  @@index([createdAt])
  @@index([eventId]) // Unique index는 자동 생성되지만 명시적으로 추가
}

// 5. 핸들 의존성 그래프 (Lineage Tracking)
// 연산 결과와 입력 핸들 간의 관계를 추적
model HandleDependency {
  id            String   @id @default(uuid()) // Primary Key (UUID)
  outputHandleId String   @unique // 결과 핸들 (Unique)
  inputHandles   String[] // 입력 핸들 배열
  operation      String   // 연산 타입 (예: 'ADD', 'SUB', 'AND', 'OR')
  operationType  String   // 연산 타입 분류 ('Unary', 'Binary', 'Ternary')
  signature      String?  // 트랜잭션 서명 (optional)
  slot           BigInt?  // 블록 슬롯 (optional)
  createdAt      DateTime @default(now())

  // 빠른 조회를 위한 인덱스
  @@index([outputHandleId])
  @@index([operation])
  @@index([operationType])
  @@index([slot])
}
